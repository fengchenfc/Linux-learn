# MySQL存储引擎

## 存储引擎

### 存储引擎概述

- 作为可插拔式的组件提供

mysql服务软件自带的功能程序，处理表的处理器

不同的存储引擎有不同的功能和数据存储方式

MySQL 5.0/5.1 --->  MyISAM

MySQL 5.5/5.6 --->  InnoDB





### mysql 体系结构



1. 管理工具：安装MySQL服务软件后提供的管理命令

2. 连接池：验证客户端连接及检查服务可以使用的硬件资源

3. SQL接口：把用户执行的命令传递给MySQL服务处理

4. 分析器：检查用户执行的命令是否正确

5. 优化器：优化用户执行的命令

6. 查询缓存：用来存用户曾经查找过的数据

7. 存储引擎：表的处理器

> 每种存储引擎都有自己的数据存储方式和功能。当对表里的数据做访问的时候，存储引擎就开始工作了。





## 存储引擎特点

### myisam存储引擎

- 主要特点
  - 支持表级锁
  - 不支持事务、事务回滚、外键


> 表级锁：对表做select访问或insert   /update/delete时，把整张表枷锁

> 什么是事务?
>
> 连接数据库服务器后，到断开连接期间执行的操作，统称为事务。
>
> 事务回滚：对表中给你的数据做访问时，执行失败，可以把数据库回滚到失败前的状态（表必须支持事务才可以回滚）。

- 表文件
  - 表名.frm           //表结构
  - 表名.MYI          //索引
  - 表名.MYD        //数据

### innodb存储引擎

- 主要特点
  - 支持行级锁定
  - 支持事务、事务回滚、外键

> 行级锁：仅仅对表中被访问的行分别加锁，不被访问的行不会被加锁。

- 表文件
  - 表名.frm      //表结构        
  - 表名.ibd        //表数据+索引

***innodb存储引擎的表，用事务日志文件记录执行过的操作。***

```bash
[root@sql50 ~]# cd /var/lib/mysql/   
[root@sql50 mysql]# ls
 ib_logfile0     #事务日志文件
 ib_logfile1     #事务日志文件
```

### MySQL 锁机制

- 锁粒度

  - 表级锁：对整张表加锁
  - 行级锁：仅对被访问的行分别加锁

- 锁类型

  - 读锁（共享锁）：对整张表加锁

> 当对表里的数据做查询访问时，mysql访问会给表加读锁，在读锁期间，允许再select访问请求，不允许写访问

  - 
      - 写锁（排它锁/互斥锁）：是独占锁，上锁期间其他线程不能读表或写表

> 当对表里的数据做写访问时，MySQL访问会给表加写锁，加写锁期间不允许任何访问。

- 查看当前锁状态

`show status like "table_lock%";`

### 事务特性(ACID)

- Atomic: 原子性
  - 事务的整个操作时一个整体,不可分割
  - 要么全部成功,要么全部失败
- Consistency: 一致性
  - 事务操作的前后,表中的记录没有变化
- Lsolation: 隔离性
  - 事务操作是互相隔离不受影响的
- Durability: 持久性
  - 数据一旦提交,不可改变,永久改变表数据

#### 相关命令

```bash
mysql> show variables like "autocommit";  #查看提交状态
mysql> set autocommit=off;  #关闭自动提交
mysql> rollback;     #数据回滚
mysql> commit;    #提交数据
```

## 建表时,如何决定表使用哪种存储引擎?

接收查询访问多的表,适合使用myisam存储引擎,节省系统资源;

> `select * from  db1.user ；` 加读锁
>
> ​                                          表级锁  锁表1次
>
> ​                                          行级锁  给每行分别加锁



接收写访问insert/update/delete 多的表，适合使用innodb存储引擎，并访问量大。

>  `update db1.user set school="tarena" where id <=3;`
>
> 写锁  表级锁  锁整张表
>
> ​          行级锁  只对被访问的行分别加锁  不影响其他人对其他行进行操作 


